---
# --- Podman Client for connecting to Podman Desktop on Windows ---
# Based on: https://podman-desktop.io/docs/podman/accessing-podman-from-another-wsl-instance
#
# Installs podman as a remote client (no local engine) that connects to
# Podman Desktop running on Windows via a shared WSL socket.
# Also provides full Docker backwards-compatibility (docker → podman).

# ── 1. Package Installation ─────────────────────────────────────────────────

- name: Install podman and podman-docker packages
  apt:
    name:
      - podman
      - podman-docker
    state: present
    update_cache: yes

- name: Install pipx for isolated Python package installations
  apt:
    name: pipx
    state: present

- name: Ensure pipx path is set up for {{ username }}
  shell: pipx ensurepath
  become: true
  become_user: "{{ username }}"
  changed_when: false
  failed_when: false

- name: Install podman-compose via pipx
  shell: pipx install podman-compose
  become: true
  become_user: "{{ username }}"
  args:
    creates: "/home/{{ username }}/.local/bin/podman-compose"

# ── 2. Socket Detection ─────────────────────────────────────────────────────
# Podman Desktop versions may expose the socket at different paths.
# We check both and use whichever exists (prefer podman.sock).

- name: Check for Podman Desktop socket (primary path)
  stat:
    path: /mnt/wsl/podman-sockets/podman.sock
  register: podman_socket_primary

- name: Check for Podman Desktop socket (alternative path)
  stat:
    path: /mnt/wsl/podman-sockets/podman-machine-default-api.sock
  register: podman_socket_alt

- name: Set detected socket path
  set_fact:
    podman_socket_path: >-
      {%- if podman_socket_primary.stat.exists -%}
        /mnt/wsl/podman-sockets/podman.sock
      {%- elif podman_socket_alt.stat.exists -%}
        /mnt/wsl/podman-sockets/podman-machine-default-api.sock
      {%- else -%}
        none
      {%- endif -%}

- name: Verify detected socket is a valid socket file
  shell: "test -S {{ podman_socket_path }}"
  register: socket_valid
  failed_when: false
  changed_when: false
  when: podman_socket_path != 'none'

- name: Set socket availability fact
  set_fact:
    podman_socket_available: >-
      {{ podman_socket_path != 'none' and
         (socket_valid.rc | default(1)) == 0 }}

# ── 3. Warning if no socket found ───────────────────────────────────────────

- name: Warning — Podman Desktop socket not found
  debug:
    msg: |
      ⚠ Podman Desktop socket not found.

      Checked:
        - /mnt/wsl/podman-sockets/podman.sock
        - /mnt/wsl/podman-sockets/podman-machine-default-api.sock

      Please ensure:
        1. Podman Desktop is installed and running on Windows
        2. The Podman machine is STARTED (not just installed)
        3. WSL integration is enabled in Podman Desktop settings:
           Settings → Resources → Podman → ⋮ → Edit WSL instances

      After fixing, re-run flux setup.
  when: not podman_socket_available | bool

# ── 4. Idempotent Connection Setup ──────────────────────────────────────────

- name: Configure Podman connection to Podman Desktop
  become: true
  become_user: "{{ username }}"
  when: podman_socket_available | bool
  block:
    - name: Ensure containers config directory exists
      file:
        path: "/home/{{ username }}/.config/containers"
        state: directory
        mode: "0755"

    - name: List existing podman connections
      shell: >
        podman system connection list --format '{{'{{.Name}} {{.URI}}'}}'
      register: podman_connections
      changed_when: false
      failed_when: false

    - name: Determine if podman-desktop connection needs updating
      set_fact:
        podman_connection_exists: >-
          {{ 'podman-desktop' in (podman_connections.stdout | default('')) }}
        podman_connection_correct: >-
          {{ ('podman-desktop unix://' ~ podman_socket_path) in
             (podman_connections.stdout | default('')) }}

    - name: Remove stale podman-desktop connection
      shell: podman system connection remove podman-desktop
      when: podman_connection_exists | bool and not podman_connection_correct | bool
      changed_when: true
      failed_when: false

    - name: Add podman-desktop connection
      shell: >
        podman system connection add
        podman-desktop
        unix://{{ podman_socket_path }}
      when: not podman_connection_correct | bool
      changed_when: true

    - name: Set podman-desktop as default connection
      shell: podman system connection default podman-desktop
      register: set_default_result
      changed_when: true
      failed_when: false

    - name: Verify Podman connection works
      shell: timeout 5 podman version
      register: podman_version
      failed_when: false
      changed_when: false

    - name: Display Podman connection status
      debug:
        msg: "✓ Podman successfully connected to Podman Desktop via {{ podman_socket_path }}"
      when: podman_version.rc == 0

    - name: Warning — Podman connection test failed
      debug:
        msg: |
          ⚠ Podman connection test failed or timed out.

          Socket detected at: {{ podman_socket_path }}
          This usually means the Podman machine is not running.

          To fix:
            1. Open Podman Desktop on Windows
            2. Go to "Podman" or "Machines" section
            3. Start the Podman machine
            4. Wait for "Running" status
            5. Re-run flux setup
      when: podman_version.rc != 0