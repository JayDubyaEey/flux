---
# --- Podman Client for connecting to Podman Desktop on Windows ---
# Based on: https://podman-desktop.io/docs/podman/accessing-podman-from-another-wsl-instance
#
# Installs podman as a remote client (no local engine) that connects to
# Podman Desktop running on Windows via a shared WSL socket.
# Also provides full Docker backwards-compatibility (docker → podman).

# ── 1. Package Installation ─────────────────────────────────────────────────

- name: Fetch latest Podman release version from GitHub
  uri:
    url: https://api.github.com/repos/containers/podman/releases/latest
    return_content: yes
  register: podman_release_info
  failed_when: false

- name: Set Podman version from API response
  set_fact:
    podman_version: "{{ podman_release_info.json.tag_name }}"
  when: podman_release_info is succeeded and podman_release_info.json.tag_name is defined

- name: Fallback to hardcoded Podman version if API fails
  set_fact:
    podman_version: "v4.9.1"
  when: podman_release_info is failed or podman_release_info.json.tag_name is not defined

- name: Display target Podman version
  debug:
    msg: "Target Podman version: {{ podman_version }}"

- name: Download podman-remote-static binary
  get_url:
    url: "https://github.com/containers/podman/releases/download/{{ podman_version }}/podman-remote-static-linux_amd64.tar.gz"
    dest: /tmp/podman-remote-static-linux_amd64.tar.gz
    mode: '0644'

- name: Extract podman-remote-static to /usr/local
  unarchive:
    src: /tmp/podman-remote-static-linux_amd64.tar.gz
    dest: /usr/local
    remote_src: yes
    creates: /usr/local/bin/podman-remote-static-linux_amd64

- name: Detect user's default shell
  shell: "getent passwd {{ username }} | cut -d: -f7"
  register: user_shell
  changed_when: false

- name: Set shell rc file fact
  set_fact:
    shell_rc_file: "{{ '/home/' + username + '/.zshrc' if 'zsh' in user_shell.stdout else '/home/' + username + '/.bashrc' }}"

- name: Add PATH and podman alias to shell rc file
  blockinfile:
    path: "{{ shell_rc_file }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Podman Remote"
    block: |
      export PATH="$PATH:/usr/local/bin"
      alias podman='podman-remote-static-linux_amd64'
    create: yes
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: '0644'

# ── 2. Socket Detection ─────────────────────────────────────────────────────
# Per the official docs, Podman Desktop exposes a rootless socket in WSL:
#   - Rootless: /mnt/wsl/podman-sockets/podman-machine-default/podman-user.sock
# We assume rootless mode for security and simplicity.

# NOTE: In WSL, sockets shared across distros via /mnt/wsl appear as regular
# files to stat/test -S, but function correctly as sockets. We only check
# for file existence here; actual connectivity is verified by `podman version`.

- name: Check for rootless Podman socket
  stat:
    path: /mnt/wsl/podman-sockets/podman-machine-default/podman-user.sock
  register: podman_socket_rootless

- name: Set socket availability fact
  set_fact:
    podman_socket_available: "{{ podman_socket_rootless.stat.exists }}"

# ── 3. Warning if no socket found ───────────────────────────────────────────

- name: Warning — Podman Desktop socket not found
  debug:
    msg: |
      ⚠ Podman Desktop rootless socket not found.

      Checked:
        - /mnt/wsl/podman-sockets/podman-machine-default/podman-user.sock (rootless)

      Please ensure:
        1. Podman Desktop is installed and running on Windows
        2. The Podman machine is STARTED (not just installed)
        3. WSL integration is enabled in Podman Desktop settings:
           Settings → Resources → Podman → ⋮ → Edit WSL instances
        4. Rootless mode is enabled in Podman Desktop

      Ref: https://podman-desktop.io/docs/podman/accessing-podman-from-another-wsl-instance

      After fixing, re-run flux setup.
  when: not podman_socket_available | bool

# ── 4. Idempotent Connection Setup ──────────────────────────────────────────
# Configure rootless connection to Podman Desktop.
# Ref: https://podman-desktop.io/docs/podman/accessing-podman-from-another-wsl-instance

- name: Configure Podman rootless connection to Podman Desktop
  become: true
  become_user: "{{ username }}"
  when: podman_socket_available | bool
  block:
    - name: Ensure containers config directory exists
      file:
        path: "/home/{{ username }}/.config/containers"
        state: directory
        mode: "0755"

    - name: List existing podman connections
      shell: podman system connection list --format '{{'{{.Name}}'}}'
      register: podman_connections
      changed_when: false
      failed_when: false

    # ── Rootless connection ──────────────────────────────────────────────

    - name: Remove existing rootless connection
      shell: podman system connection remove podman-machine-default-user
      when: "'podman-machine-default-user' in (podman_connections.stdout | default(''))"
      changed_when: true
      failed_when: false

    - name: Add rootless connection
      shell: "podman system connection add podman-machine-default-user unix:///mnt/wsl/podman-sockets/podman-machine-default/podman-user.sock"
      changed_when: true
      failed_when: false

    - name: Set rootless as default connection
      shell: podman system connection default podman-machine-default-user
      changed_when: true
      failed_when: false

    # ── Verify ───────────────────────────────────────────────────────────

    - name: Verify Podman connection works
      shell: timeout 5 podman version
      register: podman_version
      failed_when: false
      changed_when: false

    - name: Display Podman connection status
      debug:
        msg: >
          ✓ Podman connected to Podman Desktop in rootless mode.
          Connection: podman-machine-default-user
      when: podman_version.rc == 0

    - name: Warning — Podman connection test failed
      debug:
        msg: |
          ⚠ Podman connection test failed or timed out.

          This usually means the Podman machine is not running.

          To fix:
            1. Open Podman Desktop on Windows
            2. Go to "Podman" or "Machines" section
            3. Start the Podman machine
            4. Wait for "Running" status
            5. Re-run flux setup

          Ref: https://podman-desktop.io/docs/podman/accessing-podman-from-another-wsl-instance
      when: podman_version.rc != 0

# ── 5. podman-compose Installation ──────────────────────────────────────────
# Install podman-compose for Docker Compose compatibility
# Dependencies (Python3, PyYAML, python-dotenv) should be installed via python role

- name: Check for Python3
  command: python3 --version
  register: python3_check
  failed_when: false
  changed_when: false

- name: Check for PyYAML
  command: python3 -c "import yaml"
  register: pyyaml_check
  failed_when: false
  changed_when: false

- name: Check for python-dotenv
  command: python3 -c "import dotenv"
  register: dotenv_check
  failed_when: false
  changed_when: false

- name: Fail if podman-compose dependencies are missing
  fail:
    msg: |
      ⚠ podman-compose dependencies are missing.

      Required dependencies:
        - Python3: {{ 'OK' if python3_check.rc == 0 else 'MISSING' }}
        - PyYAML: {{ 'OK' if pyyaml_check.rc == 0 else 'MISSING' }}
        - python-dotenv: {{ 'OK' if dotenv_check.rc == 0 else 'MISSING' }}

      To fix this:
        1. Ensure the python role is enabled in your playbook
        2. Make sure install_python is set to true
        3. The python role should run BEFORE the podman role
        4. Re-run flux setup

      The python role will install these dependencies automatically.
  when: python3_check.rc != 0 or pyyaml_check.rc != 0 or dotenv_check.rc != 0

- name: Install podman-compose via pip
  pip:
    name: podman-compose
    state: present
    executable: pip3
  when: python3_check.rc == 0 and pyyaml_check.rc == 0 and dotenv_check.rc == 0
