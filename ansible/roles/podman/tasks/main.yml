---
# --- Podman Client for connecting to Podman Desktop on Windows ---

- name: Install podman package from Ubuntu repos
  apt:
    name: podman
    state: present
    update_cache: yes

- name: Ensure pip is installed
  apt:
    name: python3-pip
    state: present

- name: Install podman-compose via pip
  pip:
    name: podman-compose
    state: present

- name: Configure Podman connection to Podman Desktop
  become: true
  become_user: "{{ username }}"
  block:
    - name: Remove old podman configuration files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/home/{{ username }}/.config/containers/containers.conf"
        - "/home/{{ username }}/.config/containers/podman-connections.conf"
      failed_when: false

    - name: Remove any old/stale connections
      shell: |
        for conn in $(podman system connection list --format '{{'{{.Name}}'}}' 2>/dev/null || true); do
          podman system connection remove "$conn" 2>/dev/null || true
        done
      changed_when: false
      failed_when: false

    - name: Add Podman Desktop connection
      shell: |
        podman system connection add \
          podman-desktop \
          unix:///mnt/wsl/podman-sockets/podman.sock
      changed_when: true

    - name: Set podman-desktop as default connection
      shell: podman system connection default podman-desktop
      changed_when: true